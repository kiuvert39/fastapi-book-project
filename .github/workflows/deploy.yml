name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up SSH Agent
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to EC2
      env:
        EC2_PUBLIC_IP: ${{ secrets.EC2_PUBLIC_IP }}
        EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@51.20.55.19 << 'EOF'
        # Define app directory path
        APP_DIR="/home/ubuntu/my-app"

        # Check if the directory exists
        if [ ! -d "$APP_DIR" ]; then
          # If it doesn't exist, clone the repository
          echo "Cloning repository into $APP_DIR"
          git clone https://github.com/kiuvert39/fastapi-book-project.git $APP_DIR
        else
          # If it exists, pull the latest changes
          echo "Pulling the latest changes in $APP_DIR"
          cd fastapi-book-project
          git pull origin main
        fi

        # Navigate to the app directory
        cd fastapi-book-project

        # Install python3-venv if not installed
        sudo apt update
        sudo apt install -y python3.12-venv

        # Check if the virtual environment exists
        if [ ! -d "venv" ]; then
          # If the virtual environment doesn't exist, create it
          echo "Creating virtual environment"
          python3 -m venv venv
        fi

        # Activate the virtual environment
        source venv/bin/activate

        # Install dependencies
        echo "Installing dependencies"
        pip install --upgrade -r requirements.txt

        # Install uvicorn if not already installed
        pip install uvicorn

        # Kill any existing FastAPI process (Optional, for a fresh start)
        echo "Stopping any existing FastAPI app"
        pkill -f uvicorn || true

        # Run the FastAPI application in the background
        echo "Starting FastAPI application"
        nohup uvicorn main:app --host 127.0.0.1 --port 8000 &

        # Optionally, you can check if the app is running
        ps aux | grep uvicorn

        EOF
